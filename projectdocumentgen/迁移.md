# 项目迁移要点文档（Flask → Next.js）

## 1. 项目简介

本项目为"工程文档 AI 处理"系统，主要功能包括：
- 文件上传（PDF、图片）
- 文件处理与任务管理（异步处理）
- 结果/状态查询
- 结果预览与下载
- AI 数据整理与表格生成
- 表格下载（Excel）

## 2. 主要依赖与结构

- Flask（Web 框架）
- PyMuPDF（PDF 处理）
- openpyxl（Excel 生成）
- loguru（日志）
- dotenv（环境变量）
- 业务逻辑分为 routes、services、utils、config 等模块

## 3. 主要路由与功能说明

| 路由                        | 方法 | 说明                                                         |
|-----------------------------|------|--------------------------------------------------------------|
| `/`                         | GET  | 健康检查，返回 API 运行状态                                   |
| `/upload`                   | POST | 文件上传，支持多文件，返回 task_id                            |
| `/process-selection`        | POST | 启动异步处理任务，参数：task_id, selected_files, selected_pages|
| `/status/<task_id>`         | GET  | 查询任务处理状态与进度                                        |
| `/result/<task_id>`         | GET  | 获取任务最终 JSON 结果                                        |
| `/download/<task_id>`       | GET  | 下载任务 JSON 结果文件                                        |
| `/preview/<filename>`       | GET  | 预览图片（原图/压缩图），需传 task_id                         |
| `/generate-table/<task_id>` | GET  | 生成工程概算表（AI 调用），返回表格 JSON                      |
| `/download-table/<task_id>` | GET  | 下载概算表 Excel 文件                                         |

### 错误处理
- 404/500 页面渲染
- 文件/任务不存在时返回 JSON 错误

## 4. 业务流程梳理

1. **上传文件**  
   用户上传 PDF/图片，后端保存到以 task_id 为名的目录，返回 task_id。

2. **选择处理内容并发起处理**  
   用户选择要处理的文件/页面，前端 POST `/process-selection`，后端异步处理（多线程/服务层）。

3. **轮询任务状态**  
   前端定时 GET `/status/<task_id>`，获取进度、结果、错误信息。

4. **结果获取与下载**  
   处理完成后，前端可 GET `/result/<task_id>` 或 `/download/<task_id>` 获取/下载 JSON 结果。

5. **图片预览**  
   前端可 GET `/preview/<filename>?task_id=xxx` 预览图片（原图/压缩图）。

6. **AI 表格生成与下载**  
   前端 GET `/generate-table/<task_id>` 生成表格，GET `/download-table/<task_id>` 下载 Excel。

## 5. 迁移到 Next.js 的建议

### 前端
- 使用 Next.js 的页面路由（app router 或 pages router）实现页面跳转与数据展示。
- 文件上传可用 `<input type="file" multiple />` + FormData，调用后端 API。
- 状态轮询可用 SWR、React Query 或自定义轮询逻辑。
- 结果展示、图片预览、表格展示可用 Ant Design、MUI 等组件库。

### 后端（API 路由）
- Next.js API 路由（/pages/api 或 /app/api）实现后端接口，复刻 Flask 路由逻辑。
- 文件存储可用 Node.js 的 fs/promises，或云存储（如 S3）。
- 异步任务可用队列（如 BullMQ）、子进程、或 serverless 方案。
- AI/第三方服务调用可用 axios/fetch。
- Excel 生成可用 exceljs。
- 日志可用 winston、pino 等。

### 目录建议

```
/app (或 /pages)
/api
  /upload
  /process-selection
  /status/[task_id]
  /result/[task_id]
  /download/[task_id]
  /preview/[filename]
  /generate-table/[task_id]
  /download-table/[task_id]
/components
/utils
/services
/public
```

### 迁移注意事项

- Python 依赖需用 Node.js 替代（如 PDF 处理、图片处理、Excel 生成）。
- AI 服务调用需适配 JS SDK 或 HTTP API。
- 文件上传/下载、图片预览需处理好静态资源与权限。
- 异步任务/队列需用 Node.js 生态方案实现。

## 6. 关键点总结

- **API 路由迁移**：每个 Flask 路由都需在 Next.js 下实现对应 API 路由。
- **文件/任务管理**：需设计 task_id 目录结构，保证多用户隔离。
- **异步处理**：Node.js 需实现异步任务队列或 serverless 处理。
- **AI/第三方服务**：需适配 JS 生态的调用方式。
- **前端交互**：文件上传、状态轮询、结果展示、表格下载等需用 React 组件实现。

## 7. 详细接口参数与数据结构

### 1. `/upload`  
- **方法**：POST
- **请求**：`multipart/form-data`，字段名为`files`，支持多文件上传。
- **返回**：
```json
{
  "task_id": "string"
}
```
- **错误返回**：
```json
{
  "error": "未选择文件" | "文件类型不支持"
}
```

---

### 2. `/process-selection`  
- **方法**：POST
- **请求**：`application/json`
```json
{
  "task_id": "string",
  "selected_files": ["filename1", "filename2"], // 可选
  "selected_pages": [1, 2, 3] // 可选
}
```
- **返回**：
```json
{
  "message": "processing started",
  "task_id": "string"
}
```
- **错误返回**：
```json
{
  "error": "请至少选择一个文件或页面"
}
```

---

### 3. `/status/<task_id>`  
- **方法**：GET
- **返回**：
```json
{
  "status": "processing" | "done" | "error",
  "total": 10, // 总任务数
  "finished": 5, // 已完成数
  "results": [ ... ], // 可选，处理结果
  "errors": [ ... ]   // 可选，错误信息
}
```

---

### 4. `/result/<task_id>`  
- **方法**：GET
- **返回**：
```json
{
  "result": { ... } // 任务最终AI处理结果，结构不定
}
```
- **错误返回**：
```json
{
  "error": "结果文件不存在或任务失败"
}
```

---

### 5. `/download/<task_id>`  
- **方法**：GET
- **返回**：下载 JSON 文件，内容同 `/result/<task_id>`
- **错误返回**：
```json
{
  "error": "结果文件不存在"
}
```

---

### 6. `/preview/<filename>?task_id=xxx`  
- **方法**：GET
- **返回**：图片二进制流，Content-Type 取决于图片类型（image/jpeg, image/png等）
- **错误返回**：HTTP 404 + "File not found"

---

### 7. `/generate-table/<task_id>`  
- **方法**：GET
- **返回**：
```json
{
  "status": "ok",
  "table": [ { ... }, ... ], // 表格行数组
  "raw": { ... } // AI原始返回的表格结构
}
```
- **错误返回**：
```json
{
  "status": "error",
  "message": "AI返回内容无法解析为表格: ...",
  "raw": "..."
}
```

---

### 8. `/download-table/<task_id>`  
- **方法**：GET
- **返回**：Excel 文件（Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet）
- **错误返回**：
```json
{
  "error": "请先生成概算表"
}
```

---

## 主要数据结构说明

### 1. 任务ID（task_id）
- 类型：string（UUID）
- 用于隔离每次上传/处理任务的文件与结果

### 2. 上传文件信息
```json
{
  "name": "文件名",
  "path": "服务器保存路径",
  "type": "pdf" | "image"
}
```

### 3. 任务状态（status）
- processing：处理中
- done：已完成
- error：出错

### 4. 结果数据结构
- `/result/<task_id>` 返回的 result 字段为 AI 处理后的原始结构，通常为嵌套 JSON。
- `/generate-table/<task_id>` 返回的 table 字段为表格行数组，示例：
```json
[
  {
    "序号": 1,
    "项目名称": "土建工程",
    "金额": 123456.78,
    ...
  },
  ...
]
```

### 5. 错误信息
- errors 字段为字符串数组或对象数组，记录处理失败的文件、页面及原因。

---

如需补充具体字段或某一接口的详细示例，请补充说明。 